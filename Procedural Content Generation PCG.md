A tool to programmatically generate [[Asset]] instances,
using point sources and filtering to position them.
The generation is implemented using [[Visual Script]].

Is implemented as a [[Plugin]], enabled at [[Top Menu Bar]] > Edit > Plugins > Procedural Content Generation Framework (PCG).
There is also a utility plugin name Procedural Content Generation Framework (PCG) Geometry Script Interop.
See [[Geometry Script]].


# Create A PCG Graph

A PCG Graph is an [[Asset]] in the [[Content Browser]].
Create with [[Content Browser]] > right-click > PCG > PCG Graph.
PCG Graph [[Asset]]s often has a name starting with `PCG_`.
To add an instance of the PCG Graph to the [[Level]] drag it from the [[Content Browser]] to the [[Level Viewport]].
This creates a PCG Volume [[Actor]] instance.


# PCG Graph Editor

The PCG Graph is a [[Visual Script]].
It is edited in the PCG Graph Editor.
Has a Palette panel with all the nodes that can be used.
Has a [[Details Panel]] showing the settings of the currently selected node,
or the PCG Graph itself if no node is selected.
Has a Graph panel where nodes are created and connected.
Nodes are created either by dragging them from the Palette panel or by right-click in the Graph panel.
Has a Preview panel (Name?) that is used to inspect the values of data as it flows through the graph.

It has an Input node and an Output node.

Changes made in the PCG Graph Editor show up immediately on instance in the [[Level Viewport]],
so it is helpful to keep one in view while editing.

Nodes can be temporarily disabled, i.e. toggle evaluation, by hitting E on the keyboard.
This is useful on Spawner nodes for hiding the thing they spawn, making it easier to see what is going on when working with points earlier in the network.

## Keyboard shortcuts

- E: Toggle evaluation of the selected node.
	- Node becomes grayed out.
- D: Toggle debugging rendering of point output of the selected node.
	- Node gets a teal icon in the top-left corner.
- A: Inspect. The node's output is listed in the Inspect panel.
	- The node gets yellow icon.

# Point

A point is the fundamental unit of information in PCG.
Most nodes create, manipulate, or consume points.

A point has a scale, which is used by Static Mesh Spawner to set the scale of the spawned Static Mesh Instance.

A point has a density, which is a scalar value.
Can be used to filter and prune points before they reach a Spawner.

We can inspect the environment around a point and use that to assign a density to the point.
For example, we can set a point's density to the dot product between a mesh's surface normal and the up vector to get higher density on top of an object and lower density on the sides and below.
This is done with the Normal To Density node.
(
At least that is what I think it does.
We pass it points and in the [[Details Panel]] we set a normal.
)

Filtering is done with the Density Filter node.
It has a range of density values and a toggle for either accepting or rejecting points within that range.


# Point Samplers

A central concept in PCG is points.
Points are generated by Samplers.
- Mesh Sampler: Generates points on the surface of a [[Static Mesh]].
- Spline Sampler: Generate points along a [[Spline Component]].


## Mesh Sampler

Requires the Procedural Content Generation Framework (PCG) Geometry Script Interop plugin to be enabled.

Has [[Details Panel]] > Settings > Static Mesh that should be set to the [[Static Mesh Asset]] to generate point on.

Has [[Details Panel]] > Settings > Sample Method:
- One Point Per Triangle: 
- One Point Per Vertex:
- Poisson Sampling: 

Can do voxelization by enabling [[Details Panel]] > Voxelize Options > Voxelize.
Places a regular grid over the mesh and sample one point per grid cell.
Set Voxel Size to get the amount and density of points you need.

## Spline Sampler

Sample points along a spline.
Typically used together with a [[Spline Component]] in the same [[Actor]] as the PCG Component and a Get Spline Data (Self) node.

[[Details Panel]] > Settings > Mode:
- Subdivision: Sample according to the spline's control points. Not sure how though.
- Distance: Sample along the spline at even intervals. The distance is set with Distance Increment just below Mode in the [[Details Panel]].

Output of the Spline Sampler node is a set of points.


# Point Manipulation

## Transform Points

Translate, rotate, and scale points, with some randomness.
A point's scale is used by Static Mesh Spawner to set the scale of the spawned Static Mesh Instance.


## Copy Points

(
Not sure what this does really, describing how it was used in the [Unreal Fest 2023 PCG introduction presentation](https://youtu.be/LMQDCEiLaQY?t=1186).
)

Transform points from one coordinate system to another.
Has two inputs:
- Source: The points to transform from world space to the target space.
- Target: The target space.

The output is the Source points transformed to be around the Target points instead.
If there are many Target points then the Input points are duplicated for each.

The Target can be the location of an [[Actor]] to make the points be around that [[Actor]].
See _Get Actor Data_ below.

## Spatial Noise

Can be set to one of several modes with [[Details Panel]] > Settings > Mode.
- Perlin 2D
- Caustic 2D
- Voronoi 2D
- Fractional Brownian 2D
- Edge Mask 2D

May need to set Transform > Scale very large, multiple hundreds, for the noise pattern to show up.


## Arithmetic

Add, subtract, multiply, etc.
Must specify which attribute of the inputs that should be operated on.
This is done at [[Details Panel]] > Input > Input Source \[12\].
Can be
- Density
- Bounds (Min|Max)
- Extents
- Color
- and more.

I don't know what happens to the other attributes.
Is the data from A used?
Does the output only have density?


## Distance

Compute the distance between a set of Source points and a set of Target points.
Don't know how the two sets are combined.
Don't know what happens if the two sets don't have the same number of points.


## Attribute Noise

Apply noise to a particular point attribute.
Have a set of operators that can be applied between the source attribute value and the noise value:
- Minimum
- Maximum
- Add
- Multiply
- and more.

The output can be different from the input.
(Haven't tested the following, I'm speculating.)
For example, we can take the Z coordinate, multiply by some noise value, and then write to density.
Then we get high density at the top and low density at the bottom of the point cloud.

## Normal To Density

Modifies the densities of the incoming points so that those that have a normal aligned with the normal set in the Normal To Density node's [[Details Panel]] get a high density,
while points with a normal orthogonal to the target normal get a low density.

## Merge

A node to which any number of points wires can be connected to the input pin.
All those points will be passed to the output.
Useful when we have multiple paths each with a Static Mesh Spawner, a Mesh Sampler, and a Copy Points.
Merge makes it so that we get points on all of the meshes.

# Spawners

The purpose of a PCG graph is to instantiate things, i.e. to spawn them.
A Spawner node takes a set of points as input and generates a set of instances as output.
Different types of spawners have different types of outputs.
For example, the Static Mesh Spawner outputs [[Static Mesh]]es.

The spawned instances are placed relative to the owning PCG Volume.
Or maybe not, maybe it is in world space.

The scale of the spawned thing is determined by the scale of the point given to the Spawner.

## Static Mesh Spawner

Spawns a [[Static Mesh]] at the input points.
Can have a selection of [[Static Mesh Asset]]s to randomly select from,
based on a weighted random distribution.

The set of [[Static Mesh Asset]]s that the Static Mesh Spawner selects among is set at [[Details Panel]] > Settings > Mesh Entries, which is an array.
Each element has:
- Static Mesh: The [[Static Mesh Asset]] to instantiate when this element is selected for a point.
- Weight: How likely this entry is to be selected for an  input point.


# World Inspection

PCG contains a bunch of nodes for inspecting the world.

## Get Actor Data

Get information about [[Actor]]s in the [[Level]].
Which [[Actor]] or [[Actor]]s is controlled with [[Details Panel]] > Settings > Actor Filter.
By default it inspects itself, the PCG Volume [[Actor]].
Can also be set to All World Actors.
In this mode we set Actor Selection to By Tag.
This is the [[Actor Tag]] that will be put on the [[Actor]]s we want to get data from.

[[Details Panel]] > Settings > Mode controls what in the [[Actor]] the node gets data for.
- Parse Actor Components: Get data for all [[Actor Component]]s in the [[Actor]].
- Get Single Point: Get the world location of the [[Actor]].
- Get Data From Property: Don't know.
- Get Data From PCG Component: Don't know.
- Get Data From PCG Component Or Parse Components: Don't know.

The output of Get Actor Data can be connected to a Points input pin.
A To Point node will be created.


## Get Spline Data

A node that reads data from a [[Spline Component]].

When the [[Details Panel]] > Settings > Actor Filter is set to Self then the PCG Component's owning [[Actor]] will be searched for a [[Spline Component]] to read data from.
I don't know how to select a particular [[Spline Component]] if there are multiple.

The output from Get Spline Data can be passed to Spline Sampler to generate points along the spline.

# Debugging

Right-click a node, not sure which nodes support this and select Debug.
A teal icon will appear on the node and gray points will appear in the [[Level Viewport]].
There are the output points of the node.

Select an instance in the debug object drop-down menu in the tool bar.
Any node > right-click > Inspect.
A yellow icon will appear on the node.
A table of points i shown in the Inspect panel.
The number of points is shown in the top-right corner of the Inspect panel.



# Blueprint Extensions

We can add custom PCG graph nodes with Blueprints.
The node to call a Blueprint implemented node is Execute Blueprint.
In its [[Details Panel]] it has Blueprint Element Type which is the Blueprint to call.
A long list of Blueprints is included with the editor.
Several of the nodes in the Palette panel are implemented as a Blueprint and show up in this list.

Some have a circle icon, some have a circled box icon.
I don't know what these mean.

Select one and the node will change name and the [[Details Panel]] is populated with the settings for that Blueprint.

Double-click the node to open the [[Visual Script]] graph implementing the node.

Example Blueprints that are not listed in the Palette panel:
- Mesh Sockets To Points: Emit a point for every socket on a [[Static Mesh]].
	- Must specify a [[Static Mesh Asset]] to get sockets from and a Tag that the sockets to emit points for should have.


# PCG Component

An [[Actor Component]].

Has [[Details Panel]] > Instance > Graph that is a reference to a PCG Graph [[Asset]].


# References

- [_Introduction to PCG Workflows in Unreal Engine 5 | Unreal Fest 2023_ by Epic Games @ youtube.com 2023](https://www.youtube.com/live/LMQDCEiLaQY)
